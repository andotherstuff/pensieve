# Pensieve Caddy Configuration
#
# Two domains:
#   DOMAIN        - API, Grafana, Prometheus (internal/admin tools)
#   PREVIEW_DOMAIN - Public Nostr event preview pages
#
# For local development (no HTTPS):
#   Set DOMAIN=localhost and PREVIEW_DOMAIN=localhost:8081 in .env
#
# For production with auto-HTTPS:
#   Set DOMAIN=api.example.com and PREVIEW_DOMAIN=preview.example.com
#   Ensure ports 80/443 are open and DNS points to this server for both domains
#   Caddy will auto-provision HTTPS certificates for both

# ═══════════════════════════════════════════════════════════════════════════════
# Main domain — API, Grafana, Prometheus
# ═══════════════════════════════════════════════════════════════════════════════
{$DOMAIN:localhost} {
    # =========================================================================
    # Grafana - Dashboards
    # =========================================================================
    handle /grafana/* {
        reverse_proxy grafana:3000
    }

    handle /grafana {
        redir /grafana/ permanent
    }

    # =========================================================================
    # Prometheus - Metrics (internal, optional exposure)
    # =========================================================================
    # Uncomment to expose Prometheus UI (useful for debugging)
    #
    # handle_path /prometheus/* {
    #     reverse_proxy prometheus:9090
    # }

    # =========================================================================
    # Pensieve API - Query Interface
    # =========================================================================
    # The API runs as a native binary on the host (not in Docker).
    # host.docker.internal resolves to the host machine from within containers.

    handle /api/* {
        reverse_proxy host.docker.internal:8080
    }

    handle /health {
        reverse_proxy host.docker.internal:8080
    }

    handle /docs {
        reverse_proxy host.docker.internal:8080
    }

    # Root
    handle / {
        respond "Pensieve is running. Visit /grafana/ for dashboards." 200
    }

    # Catch-all: 404
    handle {
        respond "Not Found" 404
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# Preview domain — Public Nostr event preview pages
# ═══════════════════════════════════════════════════════════════════════════════
# All requests are proxied to pensieve-preview on :8081.
# Caddy auto-provisions HTTPS for this domain too.
#
# URLs:
#   https://preview.example.com/{nip19_identifier}       — HTML preview
#   https://preview.example.com/{nip19_identifier}.json   — JSON API
#   https://preview.example.com/llms.txt                  — Agent docs
#   https://preview.example.com/health                    — Health check

{$PREVIEW_DOMAIN:localhost:8081} {
    reverse_proxy host.docker.internal:8081
}
