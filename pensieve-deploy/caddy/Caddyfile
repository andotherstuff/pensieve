# Pensieve Caddy Configuration
#
# This Caddyfile configures reverse proxy routes for Pensieve services.
#
# For local development (no HTTPS):
#   Set DOMAIN=localhost in .env
#
# For production with auto-HTTPS:
#   Set DOMAIN=your-domain.com in .env
#   Ensure ports 80/443 are open and DNS points to this server

# Use environment variable for domain, default to localhost
{$DOMAIN:localhost} {
    # =========================================================================
    # Grafana - Dashboards
    # =========================================================================
    # Access at: https://your-domain.com/grafana/
    # Or: http://localhost/grafana/ (local dev)

    handle /grafana/* {
        reverse_proxy grafana:3000
    }

    # Grafana also needs to handle its root for redirects
    handle /grafana {
        redir /grafana/ permanent
    }

    # =========================================================================
    # Prometheus - Metrics (internal, optional exposure)
    # =========================================================================
    # Uncomment to expose Prometheus UI (useful for debugging)
    # Access at: https://your-domain.com/prometheus/
    #
    # handle_path /prometheus/* {
    #     reverse_proxy prometheus:9090
    # }

    # =========================================================================
    # Pensieve API - Query Interface
    # =========================================================================
    # Access at: https://your-domain.com/api/
    # Health check: https://your-domain.com/health
    #
    # The API runs as a native binary on the host (not in Docker).
    # host.docker.internal resolves to the host machine from within containers.

    handle /api/* {
        reverse_proxy host.docker.internal:8080
    }

    handle /health {
        reverse_proxy host.docker.internal:8080
    }

    handle /docs {
        reverse_proxy host.docker.internal:8080
    }

    # =========================================================================
    # Pensieve Preview - Static Nostr event preview pages
    # =========================================================================
    # Access at: https://your-domain.com/{nip19_identifier}
    # JSON API: https://your-domain.com/{nip19_identifier}.json
    # Health: https://your-domain.com/health (shared with preview)
    #
    # The preview server runs as a native binary on the host (not in Docker).
    # It handles all remaining routes (NIP-19 identifiers, robots.txt, llms.txt).

    handle / {
        reverse_proxy host.docker.internal:8081
    }

    handle {
        reverse_proxy host.docker.internal:8081
    }
}

# ═══════════════════════════════════════════════════════════════════════════════
# Alternative: Subdomains (if you prefer grafana.your-domain.com)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Uncomment and modify if you want subdomain routing instead of path-based:
#
# grafana.{$DOMAIN} {
#     reverse_proxy grafana:3000
# }
#
# api.{$DOMAIN} {
#     reverse_proxy pensieve-serve:8080
# }

