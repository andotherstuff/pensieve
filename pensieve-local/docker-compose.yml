# Docker Compose for local Pensieve development
#
# This runs infrastructure services only. Rust binaries run natively for
# faster iteration and easier debugging.
#
# Start infrastructure:
#   docker compose up -d
#
# Run Rust services (from project root):
#   export PENSIEVE_API_TOKENS=dev-token
#   just run-serve                    # API server (port 8080)
#   just run-ingest                   # Ingester (port 9091 for metrics)
#
# Services:
#   ClickHouse UI: http://localhost:8123/play
#   Prometheus UI: http://localhost:9090
#   Grafana UI:    http://localhost:3000 (admin/admin)
#   API Server:    http://localhost:8080 (run separately)
#
# Connect to ClickHouse CLI:
#   docker compose exec clickhouse clickhouse-client

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: pensieve-clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native TCP interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      # Mount schema file from parent docs/ directory
      - ../docs/clickhouse_self_hosted.sql:/docker-entrypoint-initdb.d/init.sql:ro
      # Custom config (same as production, scaled down for local dev)
      - ./clickhouse/config.xml:/etc/clickhouse-server/config.d/custom.xml:ro
      # Users config (for grafana read-only user)
      - ./clickhouse/users.xml:/etc/clickhouse-server/users.d/custom.xml:ro
    environment:
      - CLICKHOUSE_DB=nostr
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: pensieve-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Grafana for dashboards
  grafana:
    image: grafana/grafana:11.0.0
    container_name: pensieve-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      # Install ClickHouse plugin on startup
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    depends_on:
      - prometheus
      - clickhouse

volumes:
  clickhouse_data:
  clickhouse_logs:
  prometheus_data:
  grafana_data:

